<!-- Screenshot Lightbox -->
@if (lightboxOpen() && app(); as app) {
  <div class="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center" (click)="closeLightbox()">
    <div class="relative w-full h-full flex items-center justify-center p-4" (click)="$event.stopPropagation()">
      <!-- Close Button -->
      <button (click)="closeLightbox()" class="absolute top-4 right-4 text-white text-3xl z-[110]">
        <i class="fa-solid fa-xmark"></i>
      </button>
      
      <!-- Image -->
      <img [src]="app.screenshots[selectedScreenshotIndex()]" alt="Screenshot" class="max-h-[90vh] max-w-[90vw] object-contain rounded-lg">

      <!-- Prev Button -->
      <button (click)="prevScreenshot()" class="absolute left-4 top-1/2 -translate-y-1/2 bg-white/20 hover:bg-white/40 text-white rounded-full w-12 h-12 flex items-center justify-center text-2xl z-[110]">
        <i class="fa-solid fa-chevron-left"></i>
      </button>

      <!-- Next Button -->
      <button (click)="nextScreenshot()" class="absolute right-4 top-1/2 -translate-y-1/2 bg-white/20 hover:bg-white/40 text-white rounded-full w-12 h-12 flex items-center justify-center text-2xl z-[110]">
        <i class="fa-solid fa-chevron-right"></i>
      </button>
    </div>
  </div>
}

<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-12">
  @if (app(); as app) {
    <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
      <!-- App Header -->
      <div class="p-6 md:flex md:items-center md:gap-6">
        <div class="md:flex-shrink-0">
          <img class="h-32 w-32 rounded-2xl mx-auto md:mx-0" [src]="app.iconUrl" [alt]="app.name">
        </div>
        <div class="mt-4 md:mt-0 text-center md:text-left flex-grow">
          <h1 class="text-3xl sm:text-4xl font-extrabold text-slate-900">{{ app.name }}</h1>
          <p class="mt-1 text-lg font-medium text-green-600">{{ app.developer }}</p>
          <div class="mt-2 flex items-center justify-center md:justify-start gap-4 text-slate-500">
             <div class="flex items-center">
              <i class="fa-solid fa-star text-yellow-400"></i>
              <span class="ml-1 font-bold">{{ app.rating }}</span>
            </div>
            <div class="flex items-center">
              <i class="fa-solid fa-download"></i>
              <span class="ml-1 font-bold">{{ app.downloads }}</span>
            </div>
             <span class="bg-slate-200 text-slate-600 px-3 py-1 rounded-full text-sm font-semibold">
              {{ app.platform }}
            </span>
          </div>
        </div>
        <div class="mt-6 md:mt-0 md:flex-shrink-0">
          <button (click)="handleDownload()" class="w-full md:w-auto bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 text-md rounded-full transition duration-300 shadow-lg shadow-green-500/30 transform hover:scale-105">
            @if (currentUser()) {
              <i class="fa-solid fa-download mr-2"></i> Download APK
            } @else {
              <i class="fa-solid fa-lock mr-2"></i> Login to Download
            }
          </button>
        </div>
      </div>

      <div class="px-6 pb-6">
        <!-- Screenshots -->
        <h2 class="text-xl font-bold text-slate-800 mb-3">Screenshots</h2>
        <div class="flex overflow-x-auto space-x-4 pb-2 screenshot-carousel">
          @for (screenshot of app.screenshots; track $index) {
            <div class="flex-shrink-0 cursor-pointer" (click)="openLightbox($index)">
                <img [src]="screenshot" alt="Screenshot {{$index + 1}}" class="h-64 w-auto rounded-lg shadow-md">
            </div>
          }
        </div>
        
        <!-- Description -->
        <div class="mt-8">
            <h2 class="text-xl font-bold text-slate-800 mb-3">About this app</h2>
            <div class="relative text-slate-600 leading-relaxed transition-all duration-300" [class.max-h-24]="!isDescriptionExpanded()" [class.overflow-hidden]="!isDescriptionExpanded()">
                <p>{{ app.description }}</p>
                @if (!isDescriptionExpanded()) {
                    <div class="absolute bottom-0 left-0 w-full h-12 bg-gradient-to-t from-white to-transparent pointer-events-none"></div>
                }
            </div>
             <button (click)="toggleDescription()" class="text-green-600 font-semibold mt-2">
                {{ isDescriptionExpanded() ? 'Read Less' : 'Read More' }}
            </button>
        </div>
      </div>
    </div>
  } @else {
    <div class="text-center py-24">
      <i class="fa-solid fa-triangle-exclamation text-6xl text-yellow-500 mb-4"></i>
      <h2 class="text-3xl font-bold text-slate-900">App Not Found</h2>
      <p class="text-slate-500 mt-2">The app you are looking for does not exist.</p>
      <div class="mt-6">
        <a routerLink="/" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-6 rounded-full transition duration-300">
          Back to Home
        </a>
      </div>
    </div>
  }
</div>
